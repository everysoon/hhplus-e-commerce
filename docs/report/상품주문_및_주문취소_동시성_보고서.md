# 상품 주문 및 주문 취소에 대한 동시성 이슈 보고서

## 1. 배경

이커머스 시스템에서는 유저가 상품을 주문하거나 주문을 취소하는 과정에서, 상품 재고 및 쿠폰과 같은 자원이 실시간으로 변경된다. 특히 인기 상품이나 한정 수량 이벤트의 경우, 여러
사용자가 동시에 동일한 상품에 접근할 수 있으며, 이로 인해 재고 정합성 및 쿠폰 사용의 충돌 문제가 발생할 가능성이 존재한다.

따라서 주문과 주문 취소 요청이 동시다발적으로 발생하는 상황에서도 데이터의 일관성을 보장하기 위해,
DB Lock(데이터베이스 락)을 적용한 트랜잭션 제어 방식을 도입하고, 이를 통해 발생할 수 있는 동시성 이슈를 사전에 방지하고자 했다.

본 보고서는 동시성 제어가 적용되기 전/후 시스템의 문제점을 비교 분석하고, 개선 효과 및 한계점을 정리한 것이다.

## 2. 문제

현재 시스템에서는 아래와 같은 방식으로 주문 및 주문 취소 로직을 처리하고 있다.

- 주문 요청 시
    - 재고 차감
    - 쿠폰이 있다면, 유저 쿠폰 사용 처리
    - 포인트 사용
- 주문 취소 시
    - 재고 복구
    - 포인트 환불
    - 유저 쿠폰 상태 복구

---

- 동시 요청이 발생할 경우, 예를 들어 A 유저가 주문하고 B 유저가 동시에 취소할 때 다음과 같은 문제가 발생할 수 있다.
    - 재고 수량이 음수로 내려감
    - 사용한 쿠폰이 복구되지 않음
    - 동일 쿠폰이 중복 적용 됨
- 트랜잭션 처리는 이루어지고 있으나, 같은 리소스에 접근할 때 락이 적용되지 않아 데이터 충돌이 발생할 가능성이 높다.

## 3. 해결방법 (TO-BE)

시스템에서는 아래와 같은 개선 방안을 적용하여 동시성 이슈를 방지했다.

1. 낙관적 락 도입
   : 주문 처리 시 재고 엔티티에 버전 컬럼(`@Version`)을 통해 update 충돌 시 rollback 발생하게 설계

2. 쿠폰 및 포인트 사용 원자화 처리
   : `OrderFacade` 하위 서비스들은 `@Transactional(propagation = MANDATORY)` 를 설정하여 하나의 트랜잭션으로 묶일 수 있도록 설계

3. 중복 성공 방지
   : `OrderStatus`를 추가 또는 `DB에 해당 userId와 productIds가 존재하면` 이라는 조건을 주어 낙관적 락의 충돌 시 재시도 중복 성공을 방지

- 왜 비관적 락이 아닌 낙관적 락을 선택했는가 ?
  : 낙관적 락이 상품 재고, 포인트, 쿠폰 등 "수정 빈도는 높지 않지만 정확해야 하는 데이터"에 적합하다고 생각했고,
  경쟁이 적을 때 비관적 락보다 매우 빠르다는 장점이 있다. 또한 해당 서비스는 실시간 동시 수정이 자주 일어나지 않아 실질 충돌이 낮은 경우의 케이스인 것 같아
  낙관적 락을 선택했다. 앞으로 서비스가 커지게 된다면 비관적 락으로 변경해도 좋을 것 같다.

## 4. 한계점

- 낙관적 락 충돌시 잦은 재시도 비용
    - 다수의 사용자가 동시에 주문 또는 취소를 시도할 경우, `OptimisticLockException`이 빈번하게 발생할 수 있으며, 이로 인해 반복적인 트랜잭션 재시도가
      필요하다.
    - 재시도 자체는 비용이 크지 않지만, 반복될 경우 서비스 응답 지연 또는 트래픽 급증 시 시스템 부하가 증가할 수 있다.
- 재시도 정책 설계의 어려움
    - 낙관적 락 충돌시 재시도 정책을 정해야되는데, 정책이 상황에 따라 다르게 적용되어야 하기 때문에 잉률적인 설계가 어렵다.
    - 잘못된 재시도 설정은 불필요한 트래픽 유발이나 성능저하로 이어질 수 있다.
- 낙관적 락은 충돌 발생 이후 처리 방식이기 때문에 DB 충돌이 한 번은 발생할 수 있고, 미리 차단하는 비관적 락에 비해 예측성이 떨어질 수 있다.
- 도메인 상태 기반의 재시도 중복 성공 방어의 한계
    - 주문상태나 중복 요청 방어로직`(DB조회->상태확인->처리)`의 흐름이기 때문에, 그 사이 타 스레드가 변경하는 경쟁 조건이 존재할 수 있다.
    - 트랜잭션 전파 수준을 강제`(MANDATORY)`로 묶어도, 호출자 트랜잭션이 적절히 롤백되지 않으면 일관성이 깨질 수 있다.

## 5. 결론

- 낙관적 락은 트래픽이 크지 않고 충돌 가능성이 낮은 환경에서 매우 효과적이다. 특히 읽기 중심 로직에서 성능을 보장하면서 동시성 이슈를 최소화할 수 있다.
- 본 시스템에서는 낙관적 락을 상품 재고와 같이 경합 가능성이 있는 자원에 적용하고, 트랜잭션 전파를 활용하여 도메인 변경을 하나의 트랜잭션으로 묶어 **원자성(
  Atomicity)**을 보장했다.
- 다만, 낙관적 락은 사후 충돌 처리라는 점에서 사용자 경험(재시도 발생, 실패 응답 등)에 영향을 줄 수 있으며, 이로 인해 충돌 회피 전략이나 백오프 전략, 상태 기반 중복
  방어 로직 등을 추가 설계하는 것이 중요하다.
- 시스템의 확장성과 성능을 고려할 때, 낙관적 락은 좋은 선택지이며, 필요시 특정 상황에서는 비관적 락, 분산 락 등의 혼합 전략도 고려할 수 있다.
