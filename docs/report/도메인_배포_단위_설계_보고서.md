# 이커머스 서비스 MSA 분리 및 분산 트랜잭션 설계 보고서

## 1. 배경

이커머스 서비스에서 상품 주문과 결제를 비롯해, 유저 잔액 관리, 재고 차캄, 쿠폰 발급 등 다얀한 기능이 복합적으로 얽혀 있습니다.
특히 현재 서비스에는 다음과 같은 기능 요구사항이 포함되어 있습니다.

- 잔액 충전 및 조회
- 상품 필터링 및 정렬조회와 인기상품 조회 기능
- 외부 결제 모듈을 가정한 주문 > 결제 흐름
- 재고,잔액 차람 및 복구 처리
- 결제 실패, 주문취소 등 예외 상황 처리

현재 모놀리식 구조에서는 단일 트랜잭션 안에서 다양한 도메인의 작업을 처리함으로써 데이터 정합성 유지가 용이했습니다.
하지만 서비스 확장과 유지보수 관점에서 MSA로 전환을 가정하고 이에 따라 발생하는 분산 트랜잭션 문제를 해결하기 위한 설계를 본 보고서에 작성하려 합니다.

## 2-1. 문제 정의

- 각 도메인의 업무책임을 명확히 하고, 서비스 별 독립적 배포 및 확장성을 고려하려 노력했습니다.

| 도메인         | 	주요 책임                     | 분리 이유                                                    |
|-------------|----------------------------|----------------------------------------------------------|
| User 서비스    | 	잔액 충전/차감                  | 민감한 금융 도메인이므로 독립 운영이 필요하기 때문에                            |
| Product 서비스 | 	상품 등록/수정/조회 및 필터링,인기상품 조회 | 트래픽이 높고 실시간 반응성이 중요하기 때문에                                |
| Order 서비스   | 	주문 조회, 생성, 취소             | 주문은 상품,결제,쿠폰,유저 등 여러 서비스와 연동되기 때문에                       |
| Payment 서비스 | 	결제 요청/취소                  | 결제는 복잡한 비동기 흐름과 예외 상황 처리가 필요하므로 외부 모듈 의존성으로부터 다른 서비스를 격리 | 
| Coupon 서비스  | 	쿠폰 발급, 사용, 만료 처리          | 쿠폰은 시간,수량,사용자 조건 등 도메인 특화 정책이 많고 정책 변경이 있을 수 있으므로        |

각 서비스는 자체 DB를 가지며, API 또는 메세지 기반으로 통신하려 합니다.

위와 같이 분리함으로써 아래와 같은 효과를 기대할 수 있습니다.
- 서비스 별 독립 배포 및 장애 격리
- 각 도메인이 명확한 책임분리를 하므로 유연한 확장이 가능하고 도메인 중심설계가 가능
- 팀 단위로 서비스를 담당할 수 있고, 책임 소재가 명확하다.
- 조회 중심 트래픽이 많은 서비스는 따로 확장이 가능 

## 2-2. 도메인 분리에 따른 주요 문제

### 문제 1. 서비스 별 독립 트랜잭션으로 인한 문제
MSA 환경에서는 서비스 간 API 호출이나 메시지 전송이 네트워크를 통해 이루어지며, 각 서비스는 자기 데이터베이스와 트랜잭션 스코프 내에서만 데이터의 ACID 보장이 가능

예: 주문 → 재고 차감 → 잔액 차감까지 성공 후 결제 실패 시, 각 서비스에 분산된 상태를 트랜잭션으로 자동 롤백 불가

이 경우, 앞 단계(재고, 잔액 차감)는 이미 각각의 서비스 내 트랜잭션에서 커밋되어 있어, 전체적으로 보면 데이터 정합성이 깨진다.

- MSA의 경우, 각 복제되는 프로세스들이 호출과 처리를 독립 트랜잭션에서 처리하게 된다.
- 복잡한 비지니스 로직이 들어가는 경우, 모든 결과가 일관성 있게 처리되어야 하나, 각 서비스가 독립 트랜잭션으로 동작하기 때문에 중간에서 실패시, 전체 상태가 일관되지 않을 수 있다.
- 정확한 다중 단계 현황의 구조가 필요하다.
- 결제는 실패했기 때문에 실제 주문은 성립되지 않은 문제가 생길 수 있으므로 이 상태를 수동으로 복구해야한다.

### 문제 2. 결제 성공 여부에 따른 비동기 흐름 제어

- 외부 PG로부터의 콜백 결과에 따라 주문 상태, 재고, 잔액, 쿠폰 상태를 정확하게 원복해야 한다.
- 외부 PG는 비동기 콜백을 통해 결제 성공/실패 여부를 알려주는 경우가 많아 비동기 응답 수신 후 성공 시 주문 확정을 지어야 한다.
- 특히 PG사가 두 번 콜백을 보내거나, 콜백이 누락되는 등의 이벤트 중복/결손의 가능성도 존재한다.

### 문제 3. 모니터링 및 장애 추적 복잡성 증가

- 트랜잭션 흐름이 분산되어 있어 어디서 실패했는지 추적하기 어렵다.
- 여러 서비스 로직 중 일부만 실패할 수 있다.

## 3. 문제 해결 전략

### 3.1 SAGA 패턴 도입 (Orchestration 기반)

예시 )

```
Order 서비스 → Product 서비스 (재고 차감)
             → User 서비스 (잔액 차감)
             → Coupon 서비스 (쿠폰 사용)
             → Payment 서비스 (결제 요청)
```

비지니스 로직 순차적으로 `Orchestrate`하여, 각 단계가 성공하면 다음 단계로 넘어가고, 실패 시 보상 트랜잭션을 수행한다.

> 단, 외부 결제 시스템처럼 보상이 불가능한 연산에 대해서는 이를 분기하여 승인 대기 상태로 유지하고, 실패 시 사람이 개입하거나 상태 기반 처리 필요하다.

### 3.2 비동기 메시징 기반 이벤트 설계

- 각 이벤트는 Kafka 또는 RabbitMQ와 같은 메세지 브로커를 사용하여 이벤트 기반으로 서비스 간 통신 할 수 있다.
- 각 이벤트 처리는 `Idempotent`(중복 호출 시 상태 불변)하게 구현되어야 한다.

### 3.3 트랜잭션 로그 및 중복 방지

- 이벤트 상태 저장 테이블 운영 `(id, event_type, payload, processed_at, status)`
- 메세지 소비 전 중복체크와 재시도 전략 포함해야 한다.

## 4. 한계점

- SAGA는 최종 일관성에 기반하므로, 즉각적이고 강한 일관성이 요구되는 상황에는 부적절하다.
- 도메인마다 보상 트랜잭션 코드를 관리할 필요가 있으므로 비즈니스 복잡성 증가할 수 있다
- 외부 결제 모듈처럼 보상 불가능한 연산은 타이밍과 흐름 제어에 대한 특별한 예외 설계가 필요하다.
- 트랜잭션 흐름이 분산되어 있어 어디서 실패했는지 추적하기 어려워 분산 추적 시스템 도입이 필요하다.

## 5. 결론

모놀리식 구조에서의 강한 트랜잭션 일관성을 MSA 환경으로 그대로 이식하기는 어렵지만

- 도메인별 명확한 책임분리
- SAGA 패턴 기반 보상 트랜잭션 설계
- 이벤트 기반 비동기 통신 및 중복 방지 및 장애 대응 설계
- 분산 추적 시스템과 재처리 전략 도입

을 통해 분산 시스템에서도 데이터 정합성을 유지하며 확장 가능한 시스템을 구현할 수 있을것 같습니다.
