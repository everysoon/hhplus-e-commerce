# 선착순 쿠폰 및 상품 주문 부하 테스트 보고서

## 1. 목적
본 보고서는 `k6`를 활용한 부하 테스트를 기반으로, 선착순 쿠폰 발급 API와 상품 주문 API의 성능을 정량적으로 평가하고, 병목 지점 분석 및 장애 대응 전략을 수립하는 것을 목적으로 한다.

## 2. 테스트 대상 및 환경

- **대상 API**
    - `POST /api/coupons/{userId}`: 선착순 쿠폰 발급
    - `POST /api/orders`: 상품 주문 처리

- **환경 구성**
    - Local + Docker (Redis, MySQL, Kafka)
    - 테스트 도구: `k6`
    - 시나리오: 100 VU(Virtual Users), 60초 간 요청 집중

## 3. 성능 지표 요약 및 병목 분석

| 지표                | 쿠폰 발급         | 상품 주문               |
|-------------------|------------------|----------------------|
| 총 요청 수            | 29,527건          | 6,274건                |
| 평균 응답 시간        | 5.09ms           | 29.04ms               |
| 응답 시간 (p95)      | 9.75ms            | 44.28ms               |
| 응답 실패율          | 0.00%             | 0.00%                 |
| iteration duration (p95) | 548.06ms       | **1.88초** (병목 의심 지점) |
| 최대 응답 시간        | 112ms             | **1.31초**            |
| 최대 iteration 시간   | 1.01초           | **2.94초**            |
| 평균 TPS            | 486.42 TPS       | 100.24 TPS           |

### ▶ 병목 분석 요약

- **상품 주문 API**
    - p95 응답 시간은 기준 만족하나, iteration 시간이 1.88초에 달해 병목 가능성 존재
    - 낮은 TPS와 높은 iteration 시간 → DB 트랜잭션 처리, 외부 연동, 동시성 제어 의심

- **쿠폰 발급 API**
    - 응답 속도 및 TPS 우수 (486.42 TPS), 안정성 확보
    - Redis 기반 락 처리 및 Lua Script 도입 여부에 따라 성능 유지 가능

## 4. 장애 시나리오 및 대응 레벨 분석

| 장애 유형                           | 레벨 | 비즈니스 영향                    | MTTD | MTTR      |
|----------------------------------|------|-------------------------------|------|-----------|
| Redis 락 병목 / 쿠폰 중복 발급           | L2   | 쿠폰 소진, 유저 불만 증가             | 수초  | 수 분 내     |
| DB Deadlock (주문 처리 중)             | L3   | 주문 실패 다발, 매출 손실, CS 유입      | 수분  | 수십 분      |
| 트래픽 급증 → GC / OOM                | L1   | 전체 서비스 불가, 매출 전면 타격        | 수초  | 수십 분 이상 |
| Kafka 소비 지연 → 포인트 적립 누락       | L2   | 주문 후 보상 실패, 신뢰 하락             | 수분  | 수십 분      |

### 장애 레벨 정의
- **L1**: 전체 서비스 불가 / 핵심 비즈니스 타격
- **L2**: 부분 기능 장애 / 유저 불편 초래
- **L3**: 성능 저하 / 기능은 유지되나 리스크 존재

---

## 5. 장애 대응 전략

### 🔹 단기 대응 (1주 이내)

| 항목                              | 설명                             |
|----------------------------------|----------------------------------|
| Redis 락 타임아웃 설정              | 무한 대기 방지, 빠른 실패 및 fallback 응답 |
| Lua Script 기반 쿠폰 처리           | 원자성 확보 및 중복 방지                     |
| Slow Query 로그 수집 및 인덱스 적용 | 주문 DB 병목 구간 조기 대응                 |
| Slack/SMS 기반 Alert 설정         | 에러율, 응답시간 등 실시간 모니터링 강화     |

### 🔸 중기 대응 (1~3개월)

| 항목                            | 설명                             |
|--------------------------------|----------------------------------|
| Kafka 소비 병렬화 및 prefetch 최적화 | 큐 처리 속도 개선, 적립 지연 해소             |
| 포인트 적립 로직 비동기 처리 분리    | 주문 API 응답 속도 확보                    |
| 자동 스케일링 및 트래픽 예측 적용    | 트래픽 급증 대비                         |
| DB Read Replica 구성             | 읽기 쿼리 분산 처리, 메인 DB 부하 완화       |

### 🔺 장기 대응 (3개월 이상)

| 항목                               | 설명                                      |
|----------------------------------|-------------------------------------------|
| 이벤트 소싱 및 CQRS 구조 적용          | 트랜잭션 비동기화, 처리 병목 제거                 |
| 분산 트레이싱 시스템 도입 (예: Jaeger) | 트랜잭션 흐름 추적, 장애 원인 식별 정밀화           |
| 혼잡 제어 전략 (RateLimit, Backpressure) | 트래픽 과부하 구간 graceful degradation 유도 |
| Chaos Engineering 실험 도입        | MTTD/MTTR 실측 기반 회복력 검증 및 개선         |

---

## 6. 종합 인사이트 및 액션 아이템

| 항목       | 인사이트 요약                                  | 액션 아이템                                             |
|------------|-----------------------------------------------|------------------------------------------------------|
| 성능       | 응답시간은 짧으나 iteration 시간 지연 있음             | 비동기 분리, 락 최적화, 트랜잭션 경합 최소화                     |
| 장애 대응력 | 응답 기반 모니터링만으로는 한계 → 트랜잭션 추적 필요      | APM 도입, Kafka/Redis 모니터링 강화, SLA 기반 Alert 설정 |
| 테스트 현실성 | 랜덤 사용자 시나리오 기반 → 실제 트래픽 반영 가능성 높음 | 매주 CI 통합 부하 테스트 실행, 시나리오 다양화                  |
| 조직 대응력 | 장애 레벨 및 MTTD/MTTR 기준 정의 완료             | RCA 기반 장애 대응 프로세스 수립 및 주기적 회고                     |

---

## 7. 결론

- 쿠폰 및 주문 API 모두 정상 범위 내 성능을 보였으나, 주문 API는 iteration 지연이 발생하며 병목 가능성이 존재함
- Redis, Kafka, DB 등 핵심 구성요소에 대한 세분화된 모니터링 및 대응 전략이 필요함
- 자동화된 부하 테스트, APM 기반 실시간 추적, 조직 차원의 장애 대응 체계를 통해 안정적 서비스 운영을 확보할 수 있음
