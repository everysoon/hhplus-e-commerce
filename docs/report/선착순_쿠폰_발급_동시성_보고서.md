## 1. 배경

선착순 쿠폰의 경우 한정된 수량에 대해 다수의 사용자가 동시에 요청을 보내는 경우가
많아, 쿠폰 수량 정합성과 발급 이력의 일관성을 보장하는 것이 중요하다.

그러나 사용자 수요가 급격히 몰릴 경우, 동시 요청 처리에 실패하거나,
중복 발급, 재고 이상 발급, 비정상 상태의 쿠폰 존재와 같은 문제가 발생할 수 있다.

본 보고서는 선착순 쿠폰 발급에서 동시성 제어가 적용되기 전/후 시스템의 문제점을 비교 분석하고,
개선 효과 및 한계점을 정리한 것이다.

## 2. 문제

- 시스템은 선착순 쿠폰에 대해 다음과 같은 조건으로 발급 로직을 구성하고 있었다
    - 사용자는 동일 쿠폰을 1회만 발급 가능
    - 쿠폰은 한정 수량이며 먼저 요청한 사용자 순으로 지급
    - 쿠폰 발급 성공 시 UserCoupon 테이블에 저장

- 동시 요청이 발생할 경우, 아래와 같은 문제가 나타남:
    - 같은 쿠폰을 중복 발급 (2명 이상에게 지급됨)
    - 쿠폰 수량이 마이너스로 내려가는 현상 발생
    - 사용자 A와 B가 동시에 요청할 경우, 둘 다 성공 처리되어 비정상 상태 기록

## 3. 해결방법 (TO-BE)

1. 비관적 락 적용
    - 쿠폰 수량 차감을 시도할 때, 해당 쿠폰 row에 `SELECT ... FOR UPDATE` 방식의 락을 적용하여 동시 접근 차단
    - 이를 통해 다수의 요청이 동시에 들어와도 순차적으로 처리되며, 쿠폰 수량의 음수화, 중복 발급 등을 방지
2. 중복 발급 방지
    - 발급 전에 `UserCoupon` 테이블에서 `userId + couponId 조합`으로 이미 존재하는지 확인
    - 존재한다면 `ALREADY_ISSUED CustomException` 예외 발생시켜 처리

- 왜 낙관적 락이 아닌 비관적 락을 선택했는가 ?
  : 선착순 쿠폰은 수량이 제한되어 있어 정확히 N명에게만 발급되어야 하고 쿠폰 수량의 정합성을 강력히 보장해야 하기 때문에 비관적락을 적용했고
  이벤트/프로모션과 같은 상황에서는 수천 명이 동시에 요청할 수 있는데 높은 동시성 환경에서 낙관적 락은 충돌 및 재시도가 너무 많다.
  비관적락을 사용하면 중복 발급/재고 초과 발급 등 치명적 버그를 사전에 방지 가능하고 비관적 락이 낙관적 락보다 "쓰기 경쟁" 상황에 더 적합하다고 생각했다.

## 4. 한계점

- 성능 저하 가능성: 동시 요청이 많을 경우, 대기 시간이 증가하여 응답 시간이 느려질 수 있음
- 스케일 아웃 한계: 다중 인스턴스 환경에서는 DB 레벨 락만으로는 한계가 있으며, 분산 환경에서는 Redis 기반 락과 같은 추가 보완이 필요
- 락 획득 실패 시 사용자 경험 저하: 쿠폰 수량이 적을 경우, 요청 대부분이 락을 얻지 못해 실패할 수 있음

## 5. 결론

- 락을 선점한 요청만 수량 차감이 가능하여, 재고 이상 발급과 중복 발급을 방지하는 데 매우 효과적이다.
- 트랜잭션 전파를 이용해 하나의 트랜잭션으로 묶어 실패시 전체 롤백이 되도록 설계했다.
- 수량 초과, 중복 발급, 비정상 상태 기록 등 선착순 쿠폰에서 자주 발생하는 이슈를 트랜잭션 레벨에서 사전에 차단할 수 있어, 단순하고 명확한 처리가 가능하다.
